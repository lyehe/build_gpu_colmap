name: Build GLOMAP

on:
  workflow_call:
  push:
    branches: [master, main]
    paths:
      - 'CMakeLists.txt'
      - 'vcpkg.json'
      - 'overlay-ports/**'
      - 'cmake/**'
      - 'third_party/glomap/**'
      - 'third_party/colmap-for-glomap/**'
      - 'third_party/poselib/**'
      - 'third_party/ceres-solver/**'
      - 'scripts_windows/**'
      - 'scripts_linux/**'
      - '.github/workflows/build-glomap.yml'
  pull_request:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      cuda:
        description: 'Build with CUDA'
        type: boolean
        default: true

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # CUDA 12.8.1 builds (stable)
          - os: windows-latest
            cuda: true
            cuda_version: '12.8.1'
            name: "Windows CUDA12.8"
          - os: ubuntu-22.04
            cuda: true
            cuda_version: '12.8.1'
            name: "Linux CUDA12.8"
          # CPU builds
          - os: windows-latest
            cuda: false
            name: "Windows CPU"
          - os: ubuntu-22.04
            cuda: false
            name: "Linux CPU"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Fetch submodule histories
        run: |
          # Fetch vcpkg history for baseline
          git -C third_party/vcpkg fetch --unshallow || true
          # Fetch colmap-for-glomap history for specific commit checkout
          git -C third_party/colmap-for-glomap fetch --unshallow || true
        shell: bash

      # ==================== CUDA Setup ====================
      # Note: CUDA 13.x network installer on Windows may be incomplete
      # Using 'local' method for more complete installation
      - name: Install CUDA Toolkit (Windows)
        if: matrix.cuda && runner.os == 'Windows'
        uses: Jimver/cuda-toolkit@v0.2.30
        with:
          cuda: ${{ matrix.cuda_version }}
          method: 'local'
          log-file-suffix: '-${{ matrix.name }}.log'

      - name: Verify CUDA Installation (Windows)
        if: matrix.cuda && runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "CUDA_PATH: $env:CUDA_PATH"
          Write-Host "Checking for required CUDA headers..."
          $cudaInclude = "$env:CUDA_PATH\include"
          $requiredHeaders = @(
            "cuda_runtime.h",
            "crt/host_config.h",
            "cuda.h"
          )
          $missing = @()
          foreach ($header in $requiredHeaders) {
            $path = Join-Path $cudaInclude $header
            if (Test-Path $path) {
              Write-Host "  [OK] $header"
            } else {
              Write-Host "  [MISSING] $header"
              $missing += $header
            }
          }
          if ($missing.Count -gt 0) {
            Write-Host ""
            Write-Host "ERROR: Missing CUDA headers detected!"
            Write-Host "This may indicate an incomplete CUDA Toolkit installation."
            Write-Host "CUDA version: ${{ matrix.cuda_version }}"
            # List what's actually in the include directory
            Write-Host ""
            Write-Host "Contents of $cudaInclude (first 20 items):"
            Get-ChildItem $cudaInclude -ErrorAction SilentlyContinue | Select-Object -First 20 | ForEach-Object { Write-Host "  $_" }
            exit 1
          }
          Write-Host ""
          Write-Host "CUDA installation verified successfully."

      - name: Install CUDA Toolkit (Linux)
        if: matrix.cuda && runner.os == 'Linux'
        uses: Jimver/cuda-toolkit@v0.2.30
        with:
          cuda: ${{ matrix.cuda_version }}
          method: 'network'
          linux-local-args: '["--toolkit"]'
          log-file-suffix: '-linux.log'

      # ==================== Build Tools ====================
      - name: Install Ninja (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install ninja -y

      - name: Free disk space (Linux)
        if: runner.os == 'Linux'
        run: |
          # Remove unnecessary packages to free disk space
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force || true
          echo "Disk space after cleanup:"
          df -h

      - name: Install build dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl zip unzip tar pkg-config \
            autoconf autoconf-archive automake libtool make \
            ninja-build ccache \
            libgl-dev libgl1-mesa-dev libglu1-mesa-dev libglew-dev \
            libxmu-dev libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev \
            libomp-dev

      # ==================== Compiler Caching ====================
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1
        with:
          key: ccache-glomap-${{ matrix.os }}-${{ matrix.cuda && 'cuda' || 'cpu' }}
          max-size: 2G

      - name: Configure ccache (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "/usr/lib/ccache" >> $GITHUB_PATH

      # ==================== vcpkg Setup ====================
      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: '${{ github.workspace }}/third_party/vcpkg'
          vcpkgJsonGlob: 'vcpkg.json'
        env:
          VCPKG_BINARY_SOURCES: 'clear;default,readwrite'

      # ==================== Build ====================
      - name: Setup MSVC environment (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build GLOMAP (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Building GLOMAP with CUDA=${{ matrix.cuda }}"
          # Verify MSVC is available
          Write-Host "Checking for MSVC compiler..."
          $clPath = (Get-Command cl -ErrorAction SilentlyContinue).Source
          if ($clPath) {
            Write-Host "  Found cl.exe at: $clPath"
          } else {
            Write-Host "  WARNING: cl.exe not found in PATH"
          }
          if ("${{ matrix.cuda }}" -eq "true") {
            .\scripts_windows\build_glomap.ps1 -Configuration Release
          } else {
            .\scripts_windows\build_glomap.ps1 -Configuration Release -NoCuda
          }

      - name: Build GLOMAP (Linux)
        if: runner.os == 'Linux'
        run: |
          CUDA_FLAG=""
          if [ "${{ matrix.cuda }}" != "true" ]; then
            CUDA_FLAG="--no-cuda"
          fi

          echo "Building GLOMAP with CUDA=${{ matrix.cuda }}"
          chmod +x ./scripts_linux/build_glomap.sh
          ./scripts_linux/build_glomap.sh Release $CUDA_FLAG

      # ==================== Bundle Dependencies ====================
      - name: Bundle dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $glomapBin = "build/install/glomap/bin"

          # Ensure bin directory exists
          if (-not (Test-Path $glomapBin)) {
            Write-Host "ERROR: GLOMAP bin directory not found at $glomapBin" -ForegroundColor Red
            exit 1
          }

          # Copy Ceres libraries
          if (Test-Path "build/install/ceres/bin/*.dll") {
            Write-Host "Copying Ceres DLLs..."
            Copy-Item "build/install/ceres/bin/*.dll" $glomapBin -Force
          }
          if (Test-Path "build/install/ceres/lib/*.dll") {
            Copy-Item "build/install/ceres/lib/*.dll" $glomapBin -Force
          }

          # Copy PoseLib libraries
          if (Test-Path "build/install/poselib/bin/*.dll") {
            Write-Host "Copying PoseLib DLLs..."
            Copy-Item "build/install/poselib/bin/*.dll" $glomapBin -Force
          }
          if (Test-Path "build/install/poselib/lib/*.dll") {
            Copy-Item "build/install/poselib/lib/*.dll" $glomapBin -Force
          }

          # Copy COLMAP libraries (needed for GLOMAP)
          if (Test-Path "build/install/colmap-for-glomap/bin/*.dll") {
            Write-Host "Copying COLMAP DLLs..."
            Copy-Item "build/install/colmap-for-glomap/bin/*.dll" $glomapBin -Force
          }
          if (Test-Path "build/install/colmap-for-glomap/lib/*.dll") {
            Copy-Item "build/install/colmap-for-glomap/lib/*.dll" $glomapBin -Force
          }

          # Copy vcpkg dependencies
          $vcpkgBin = "build/vcpkg_installed/x64-windows/bin"
          if (Test-Path "$vcpkgBin/*.dll") {
            Write-Host "Copying vcpkg DLLs..."
            Copy-Item "$vcpkgBin/*.dll" $glomapBin -Force
          }

          Write-Host "Bundled DLLs:" -ForegroundColor Green
          Get-ChildItem "$glomapBin/*.dll" | Select-Object Name

      - name: Bundle dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          GLOMAP_LIB="build/install/glomap/lib"
          mkdir -p "$GLOMAP_LIB"

          # Copy Ceres libraries
          if ls build/install/ceres/lib/*.so* 1>/dev/null 2>&1; then
            echo "Copying Ceres libraries..."
            cp -f build/install/ceres/lib/*.so* "$GLOMAP_LIB/" 2>/dev/null || true
          fi

          # Copy PoseLib libraries
          if ls build/install/poselib/lib/*.so* 1>/dev/null 2>&1; then
            echo "Copying PoseLib libraries..."
            cp -f build/install/poselib/lib/*.so* "$GLOMAP_LIB/" 2>/dev/null || true
          fi

          # Copy COLMAP libraries
          if ls build/install/colmap-for-glomap/lib/*.so* 1>/dev/null 2>&1; then
            echo "Copying COLMAP libraries..."
            cp -f build/install/colmap-for-glomap/lib/*.so* "$GLOMAP_LIB/" 2>/dev/null || true
          fi

          # Copy vcpkg dependencies
          VCPKG_LIB="build/vcpkg_installed/x64-linux/lib"
          if ls "$VCPKG_LIB"/*.so* 1>/dev/null 2>&1; then
            echo "Copying vcpkg libraries..."
            cp -f "$VCPKG_LIB"/*.so* "$GLOMAP_LIB/" 2>/dev/null || true
          fi

          echo "Bundled libraries:"
          ls -la "$GLOMAP_LIB/"

      # ==================== Smoke Test ====================
      - name: Smoke test GLOMAP binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $env:PATH = "build/install/glomap/bin;$env:PATH"
          $glomap = "build/install/glomap/bin/glomap.exe"

          if (-not (Test-Path $glomap)) {
            Write-Host "ERROR: glomap.exe not found at $glomap" -ForegroundColor Red
            exit 1
          }

          Write-Host "Testing GLOMAP binary..."
          & $glomap --help | Select-Object -First 10

          if ($LASTEXITCODE -ne 0) {
            Write-Host "ERROR: GLOMAP binary failed to run" -ForegroundColor Red
            exit 1
          }
          Write-Host "GLOMAP smoke test passed" -ForegroundColor Green

      - name: Smoke test GLOMAP binary (Linux)
        if: runner.os == 'Linux'
        run: |
          export LD_LIBRARY_PATH="build/install/glomap/lib:$LD_LIBRARY_PATH"

          if [ ! -f "build/install/glomap/bin/glomap" ]; then
            echo "ERROR: glomap binary not found"
            exit 1
          fi

          echo "Testing GLOMAP binary..."
          ./build/install/glomap/bin/glomap --help | head -10

          if [ $? -ne 0 ]; then
            echo "ERROR: GLOMAP binary failed to run"
            exit 1
          fi
          echo "GLOMAP smoke test passed"

      # ==================== Artifacts ====================
      - name: Prepare artifact name
        id: artifact-name
        shell: bash
        run: |
          if [ "${{ matrix.cuda }}" = "true" ]; then
            # Include CUDA version in artifact name to avoid conflicts
            CUDA_SUFFIX="CUDA${{ matrix.cuda_version }}"
          else
            CUDA_SUFFIX="CPU"
          fi
          echo "name=GLOMAP-${{ matrix.os }}-${CUDA_SUFFIX}" >> $GITHUB_OUTPUT

      - name: Upload GLOMAP artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact-name.outputs.name }}
          path: |
            build/install/glomap/
          retention-days: 7
          if-no-files-found: error
