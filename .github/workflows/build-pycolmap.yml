name: Build pycolmap Wheels

on:
  workflow_call:
  push:
    branches: [master, main]
    paths:
      - 'CMakeLists.txt'
      - 'vcpkg.json'
      - 'third_party/colmap-for-pycolmap/**'
      - 'third_party/ceres-solver/**'
      - 'scripts_windows/**'
      - 'scripts_linux/**'
      - '.github/workflows/build-pycolmap.yml'
  pull_request:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      cuda:
        description: 'Build with CUDA'
        type: boolean
        default: true
      python_version:
        description: 'Python version (leave empty for all)'
        type: string
        default: ''

jobs:
  build-wheels:
    name: py${{ matrix.python-version }} ${{ matrix.os }} ${{ matrix.cuda && matrix.cudss && format('CUDA{0}+cuDSS', matrix.cuda_version) || matrix.cuda && format('CUDA{0}', matrix.cuda_version) || 'CPU' }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-22.04]
        python-version: ['3.10', '3.11', '3.12', '3.13', '3.14']
        cuda: [true, false]
        cudss: [false]  # Default: no cuDSS
        cuda_version: ['12.8.1']
        include:
          # Add cuDSS variants for CUDA builds (Windows only for now - smaller matrix)
          - os: windows-latest
            python-version: '3.10'
            cuda: true
            cudss: true
            cuda_version: '12.8.1'
          - os: windows-latest
            python-version: '3.11'
            cuda: true
            cudss: true
            cuda_version: '12.8.1'
          - os: windows-latest
            python-version: '3.12'
            cuda: true
            cudss: true
            cuda_version: '12.8.1'
          - os: windows-latest
            python-version: '3.13'
            cuda: true
            cudss: true
            cuda_version: '12.8.1'
          - os: windows-latest
            python-version: '3.14'
            cuda: true
            cudss: true
            cuda_version: '12.8.1'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Fetch vcpkg history for baseline
        run: git -C third_party/vcpkg fetch --unshallow || true
        shell: bash

      # ==================== Disk Space Cleanup ====================
      - name: Free disk space (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "Disk space before cleanup:"
          df -h
          # Remove unnecessary large packages
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/share/swift
          # Clean apt cache
          sudo apt-get clean
          echo "Disk space after cleanup:"
          df -h

      # ==================== Python Setup ====================
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Python build dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install scikit-build-core[pyproject] pybind11 delvewheel

      # ==================== CUDA Setup ====================
      - name: Install CUDA Toolkit (Windows)
        if: matrix.cuda && runner.os == 'Windows'
        uses: Jimver/cuda-toolkit@v0.2.30
        with:
          cuda: ${{ matrix.cuda_version }}
          method: 'network'
          sub-packages: '["nvcc", "nvtx", "cudart", "curand", "curand_dev", "nvrtc", "nvrtc_dev", "nvjitlink", "cublas", "cublas_dev", "cusparse", "cusparse_dev", "cusolver", "cusolver_dev", "cufft", "cufft_dev"]'
          log-file-suffix: '-windows-py${{ matrix.python-version }}-cuda${{ matrix.cuda_version }}.log'

      - name: Install CUDA Toolkit (Linux)
        if: matrix.cuda && runner.os == 'Linux'
        uses: Jimver/cuda-toolkit@v0.2.30
        with:
          cuda: ${{ matrix.cuda_version }}
          method: 'network'
          linux-local-args: '["--toolkit"]'
          log-file-suffix: '-linux-py${{ matrix.python-version }}-cuda${{ matrix.cuda_version }}.log'

      # ==================== cuDSS Setup ====================
      - name: Install cuDSS (Windows)
        if: matrix.cuda && matrix.cudss && runner.os == 'Windows'
        shell: pwsh
        run: |
          $cudaVersion = "${{ matrix.cuda_version }}"
          $cudaMajor = $cudaVersion.Split('.')[0]

          Write-Host "Downloading cuDSS for CUDA $cudaMajor..."
          $cudssUrl = "https://developer.download.nvidia.com/compute/cudss/redist/libcudss/windows-x86_64/libcudss-windows-x86_64-0.7.1.4_cuda${cudaMajor}-archive.zip"

          Invoke-WebRequest -Uri $cudssUrl -OutFile cudss.zip -UseBasicParsing
          Expand-Archive cudss.zip -DestinationPath "C:/cudss"

          $cudssPath = Get-ChildItem -Path "C:/cudss" -Directory | Select-Object -First 1
          Write-Host "cuDSS installed at: $($cudssPath.FullName)"
          echo "CUDSS_ROOT=$($cudssPath.FullName)" >> $env:GITHUB_ENV

          # Find cudss_DIR (CMake config location)
          $cudssDir = "$($cudssPath.FullName)/lib/$cudaMajor/cmake/cudss"
          if (-not (Test-Path $cudssDir)) {
            $cudssDir = "$($cudssPath.FullName)/lib/cmake/cudss"
          }
          Write-Host "cudss_DIR: $cudssDir"
          echo "cudss_DIR=$cudssDir" >> $env:GITHUB_ENV

      - name: Install cuDSS (Linux)
        if: matrix.cuda && matrix.cudss && runner.os == 'Linux'
        run: |
          CUDA_VERSION="${{ matrix.cuda_version }}"
          CUDA_MAJOR="${CUDA_VERSION%%.*}"

          echo "Downloading cuDSS for CUDA $CUDA_MAJOR..."
          CUDSS_URL="https://developer.download.nvidia.com/compute/cudss/redist/libcudss/linux-x86_64/libcudss-linux-x86_64-0.7.1.4_cuda${CUDA_MAJOR}-archive.tar.xz"

          wget -nv "$CUDSS_URL" -O cudss.tar.xz
          sudo mkdir -p /opt/nvidia/cudss
          sudo tar -xf cudss.tar.xz -C /opt/nvidia/cudss --strip-components=1

          echo "cuDSS installed at: /opt/nvidia/cudss"
          echo "CUDSS_ROOT=/opt/nvidia/cudss" >> $GITHUB_ENV

          # Find cudss_DIR (CMake config location)
          if [ -d "/opt/nvidia/cudss/lib/$CUDA_MAJOR/cmake/cudss" ]; then
            CUDSS_DIR="/opt/nvidia/cudss/lib/$CUDA_MAJOR/cmake/cudss"
          else
            CUDSS_DIR="/opt/nvidia/cudss/lib/cmake/cudss"
          fi
          echo "cudss_DIR: $CUDSS_DIR"
          echo "cudss_DIR=$CUDSS_DIR" >> $GITHUB_ENV

      # ==================== Build Tools ====================
      - name: Install Ninja (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install ninja -y

      # Setup MSVC environment so cl.exe is in PATH for CUDA/vcpkg builds
      - name: Setup MSVC Developer Command Prompt
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install build dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl zip unzip tar pkg-config \
            autoconf autoconf-archive automake libtool make \
            ninja-build ccache patchelf \
            libgl-dev libgl1-mesa-dev libglu1-mesa-dev libglew-dev \
            libxmu-dev libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev \
            libomp-dev

      # ==================== Compiler Caching ====================
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1
        with:
          key: ccache-pycolmap-${{ matrix.os }}-${{ matrix.cuda && 'cuda' || 'cpu' }}-py${{ matrix.python-version }}
          max-size: 2G

      - name: Configure ccache (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "/usr/lib/ccache" >> $GITHUB_PATH

      # ==================== vcpkg Setup ====================
      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: '${{ github.workspace }}/third_party/vcpkg'
          vcpkgJsonGlob: 'vcpkg.json'
        env:
          VCPKG_BINARY_SOURCES: 'clear;default,readwrite'

      # ==================== Build COLMAP-for-pycolmap ====================
      - name: Build COLMAP-for-pycolmap (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $cudaFlag = if ("${{ matrix.cuda }}" -eq "true") { "ON" } else { "OFF" }
          $cudssFlag = if ("${{ matrix.cudss }}" -eq "true") { "ON" } else { "OFF" }

          Write-Host "Building COLMAP-for-pycolmap with CUDA=$cudaFlag cuDSS=$cudssFlag"

          # Create build directory
          New-Item -ItemType Directory -Force -Path build | Out-Null
          Set-Location build

          # Configure
          $vcpkgToolchain = "${{ github.workspace }}/third_party/vcpkg/scripts/buildsystems/vcpkg.cmake"

          # Build cmake args
          $cmakeArgs = @(
            "-G", "Ninja",
            "-DCMAKE_TOOLCHAIN_FILE=$vcpkgToolchain",
            "-DCMAKE_BUILD_TYPE=Release",
            "-DCUDA_ENABLED=$cudaFlag",
            "-DBUILD_COLMAP=OFF",
            "-DBUILD_COLMAP_FOR_PYCOLMAP=ON"
          )

          # Add cuDSS paths if enabled
          if ("${{ matrix.cudss }}" -eq "true" -and $env:cudss_DIR) {
            Write-Host "Adding cuDSS from: $env:cudss_DIR"
            $cmakeArgs += "-Dcudss_DIR=$env:cudss_DIR"
          }

          cmake .. @cmakeArgs `
            -DBUILD_CERES=ON `
            -DGFLAGS_USE_TARGET_NAMESPACE=ON

          # Build
          cmake --build . --config Release --parallel

      - name: Build COLMAP-for-pycolmap (Linux)
        if: runner.os == 'Linux'
        run: |
          CUDA_FLAG="${{ matrix.cuda && 'ON' || 'OFF' }}"
          CUDSS_FLAG="${{ matrix.cudss && 'true' || 'false' }}"

          echo "Building COLMAP-for-pycolmap with CUDA=$CUDA_FLAG cuDSS=$CUDSS_FLAG"

          # Create build directory
          mkdir -p build
          cd build

          # Build cmake args
          CMAKE_ARGS=(
            -G Ninja
            -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/third_party/vcpkg/scripts/buildsystems/vcpkg.cmake"
            -DCMAKE_BUILD_TYPE=Release
            -DCUDA_ENABLED="$CUDA_FLAG"
            -DBUILD_COLMAP=OFF
            -DBUILD_COLMAP_FOR_PYCOLMAP=ON
            -DBUILD_CERES=ON
          )

          # Add cuDSS paths if enabled
          if [ "$CUDSS_FLAG" = "true" ] && [ -n "$cudss_DIR" ]; then
            echo "Adding cuDSS from: $cudss_DIR"
            CMAKE_ARGS+=(-Dcudss_DIR="$cudss_DIR")
          fi

          # Configure
          cmake .. "${CMAKE_ARGS[@]}" \
            -DGFLAGS_USE_TARGET_NAMESPACE=ON

          # Build
          cmake --build . --config Release --parallel

      # ==================== Build Python Wheel ====================
      - name: Build wheel (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        working-directory: third_party/colmap-for-pycolmap
        run: |
          # Get paths
          $vcpkgToolchain = "${{ github.workspace }}/third_party/vcpkg/scripts/buildsystems/vcpkg.cmake".Replace('\', '/')
          $vcpkgInstalled = "${{ github.workspace }}/build/vcpkg_installed".Replace('\', '/')
          $colmapInstall = "${{ github.workspace }}/build/install/colmap-for-pycolmap".Replace('\', '/')
          $ceresInstall = "${{ github.workspace }}/build/install/ceres".Replace('\', '/')
          $pybind11Dir = (python -c "import pybind11; print(pybind11.get_cmake_dir())").Replace('\', '/')

          $cmakePrefixPath = "${colmapInstall};${ceresInstall};${pybind11Dir}"

          Write-Host "CMAKE_TOOLCHAIN_FILE: $vcpkgToolchain"
          Write-Host "VCPKG_INSTALLED_DIR: $vcpkgInstalled"
          Write-Host "CMAKE_PREFIX_PATH: $cmakePrefixPath"
          Write-Host "Note: CUDA_ENABLED=OFF for wheel build (uses pre-built CUDA-enabled COLMAP)"

          # Build wheel - CUDA_ENABLED=OFF because we link against pre-built COLMAP
          # The COLMAP library already has CUDA support, wheel doesn't compile CUDA code
          # For CUDA builds: Use Ninja generator with CMAKE_CUDA_COMPILER since VS generator
          # requires CUDA Visual Studio toolset integration which isn't reliably available
          $cudaArgs = @()
          if ("${{ matrix.cuda }}" -eq "true") {
            $cudaCompiler = "$env:CUDA_PATH/bin/nvcc.exe".Replace('\', '/')
            Write-Host "Setting CMAKE_CUDA_COMPILER: $cudaCompiler"
            Write-Host "Using Ninja generator to avoid VS CUDA toolset requirement"
            $cudaArgs = @(
              "--config-settings=cmake.define.CMAKE_CUDA_COMPILER=${cudaCompiler}",
              "--config-settings=cmake.args=-G Ninja"
            )
          }

          python -m pip wheel . --no-deps -w wheelhouse `
            --config-settings="cmake.define.CMAKE_TOOLCHAIN_FILE=${vcpkgToolchain}" `
            --config-settings="cmake.define.VCPKG_INSTALLED_DIR=${vcpkgInstalled}" `
            --config-settings="cmake.define.CMAKE_PREFIX_PATH=${cmakePrefixPath}" `
            --config-settings="cmake.define.VCPKG_TARGET_TRIPLET=x64-windows" `
            --config-settings="cmake.define.CUDA_ENABLED=OFF" `
            @cudaArgs

      - name: Build wheel (Linux)
        if: runner.os == 'Linux'
        working-directory: third_party/colmap-for-pycolmap
        run: |
          # Get paths
          VCPKG_TOOLCHAIN="${{ github.workspace }}/third_party/vcpkg/scripts/buildsystems/vcpkg.cmake"
          VCPKG_INSTALLED="${{ github.workspace }}/build/vcpkg_installed"
          COLMAP_INSTALL="${{ github.workspace }}/build/install/colmap-for-pycolmap"
          CERES_INSTALL="${{ github.workspace }}/build/install/ceres"
          PYBIND11_DIR=$(python -c "import pybind11; print(pybind11.get_cmake_dir())")

          # CMake expects semicolons as list separators (not colons)
          CMAKE_PREFIX_PATH="${COLMAP_INSTALL};${CERES_INSTALL};${PYBIND11_DIR}"

          echo "CMAKE_TOOLCHAIN_FILE: $VCPKG_TOOLCHAIN"
          echo "VCPKG_INSTALLED_DIR: $VCPKG_INSTALLED"
          echo "CMAKE_PREFIX_PATH: $CMAKE_PREFIX_PATH"
          echo "Note: CUDA_ENABLED=OFF for wheel build (uses pre-built CUDA-enabled COLMAP)"

          # Build wheel - CUDA_ENABLED=OFF because we link against pre-built COLMAP
          # The COLMAP library already has CUDA support, wheel doesn't compile CUDA code
          python -m pip wheel . --no-deps -w wheelhouse \
            --config-settings="cmake.define.CMAKE_TOOLCHAIN_FILE=${VCPKG_TOOLCHAIN}" \
            --config-settings="cmake.define.VCPKG_INSTALLED_DIR=${VCPKG_INSTALLED}" \
            --config-settings="cmake.define.CMAKE_PREFIX_PATH=${CMAKE_PREFIX_PATH}" \
            --config-settings="cmake.define.VCPKG_TARGET_TRIPLET=x64-linux" \
            --config-settings="cmake.define.CUDA_ENABLED=OFF"

      # ==================== Repair Wheel ====================
      - name: Repair wheel with delvewheel (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        working-directory: third_party/colmap-for-pycolmap
        run: |
          $vcpkgBin = "${{ github.workspace }}/build/vcpkg_installed/x64-windows/bin"
          $colmapBin = "${{ github.workspace }}/build/install/colmap-for-pycolmap/bin"

          # Build list of paths for delvewheel
          $addPaths = @(
            "--add-path", "$vcpkgBin",
            "--add-path", "$colmapBin"
          )

          # Add CUDA bin path for CUDA builds (contains nvjitlink, cudart, etc.)
          if ("${{ matrix.cuda }}" -eq "true" -and $env:CUDA_PATH) {
            $cudaBin = "$env:CUDA_PATH\bin"
            Write-Host "Adding CUDA bin path: $cudaBin"
            $addPaths += @("--add-path", "$cudaBin")
          }

          # Add cuDSS bin path for cuDSS builds
          if ("${{ matrix.cudss }}" -eq "true" -and $env:CUDSS_ROOT) {
            # cuDSS DLLs are in bin/12 or bin/13 subdirectory
            $cudssSearchDirs = @(
              "$env:CUDSS_ROOT\bin\12",
              "$env:CUDSS_ROOT\bin\13",
              "$env:CUDSS_ROOT\bin"
            )
            foreach ($dir in $cudssSearchDirs) {
              if (Test-Path "$dir\cudss*.dll") {
                Write-Host "Adding cuDSS bin path: $dir"
                $addPaths += @("--add-path", "$dir")
                break
              }
            }
          }

          $wheel = Get-ChildItem -Path wheelhouse -Filter "pycolmap-*.whl" | Select-Object -First 1

          if ($wheel) {
            Write-Host "Repairing wheel: $($wheel.Name)"
            Write-Host "Search paths: $($addPaths -join ' ')"
            python -m delvewheel repair -v @addPaths -w wheelhouse $wheel.FullName

            # Remove original wheel, keep repaired one
            # delvewheel creates a new wheel with the same name
          } else {
            Write-Error "No wheel found to repair!"
            exit 1
          }

      - name: Repair wheel with auditwheel (Linux)
        if: runner.os == 'Linux'
        working-directory: third_party/colmap-for-pycolmap
        run: |
          pip install auditwheel patchelf

          WHEEL=$(ls wheelhouse/pycolmap-*.whl | head -n 1)

          if [ -n "$WHEEL" ]; then
            echo "Repairing wheel: $WHEEL"

            # Set library paths for auditwheel - include all dependency locations
            export LD_LIBRARY_PATH="${{ github.workspace }}/build/vcpkg_installed/x64-linux/lib:${{ github.workspace }}/build/install/colmap-for-pycolmap/lib:${{ github.workspace }}/build/install/ceres/lib:$LD_LIBRARY_PATH"

            # Add CUDA library paths if CUDA build
            if [ "${{ matrix.cuda }}" = "true" ]; then
              export LD_LIBRARY_PATH="/usr/local/cuda/lib64:$LD_LIBRARY_PATH"
            fi

            # Add cuDSS library paths if cuDSS build
            if [ "${{ matrix.cudss }}" = "true" ] && [ -n "$CUDSS_ROOT" ]; then
              for dir in "$CUDSS_ROOT/lib/12" "$CUDSS_ROOT/lib64/12" "$CUDSS_ROOT/lib" "$CUDSS_ROOT/lib64"; do
                if [ -d "$dir" ]; then
                  echo "Adding cuDSS lib path: $dir"
                  export LD_LIBRARY_PATH="$dir:$LD_LIBRARY_PATH"
                  break
                fi
              done
            fi

            echo "LD_LIBRARY_PATH: $LD_LIBRARY_PATH"

            # Show wheel info first
            auditwheel show "$WHEEL" || true

            # Try repair with verbose output, exclude system libs that can't be bundled
            if auditwheel repair "$WHEEL" -w wheelhouse --plat manylinux_2_31_x86_64; then
              echo "Created manylinux_2_31_x86_64 wheel"
            elif auditwheel repair "$WHEEL" -w wheelhouse --plat manylinux2014_x86_64; then
              echo "Created manylinux2014_x86_64 wheel"
            else
              echo "WARNING: auditwheel repair failed, using original wheel"
              # Don't fail - the wheel might still work without bundling
            fi
          else
            echo "ERROR: No wheel found to repair!"
            exit 1
          fi

      # ==================== Smoke Test ====================
      - name: Smoke test pycolmap wheel (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        working-directory: third_party/colmap-for-pycolmap
        run: |
          $wheel = Get-ChildItem -Path wheelhouse -Filter "pycolmap-*.whl" | Select-Object -First 1

          if (-not $wheel) {
            Write-Host "ERROR: No wheel found in wheelhouse/" -ForegroundColor Red
            exit 1
          }

          Write-Host "Testing wheel: $($wheel.Name)"

          # Install the wheel
          python -m pip install $wheel.FullName --force-reinstall

          # Test import and version
          Write-Host "Testing pycolmap import..."
          python -c "import pycolmap; print(f'pycolmap version: {pycolmap.__version__}')"

          if ($LASTEXITCODE -ne 0) {
            Write-Host "ERROR: pycolmap import failed" -ForegroundColor Red
            exit 1
          }
          Write-Host "pycolmap smoke test passed" -ForegroundColor Green

      - name: Smoke test pycolmap wheel (Linux)
        if: runner.os == 'Linux'
        working-directory: third_party/colmap-for-pycolmap
        run: |
          WHEEL=$(ls wheelhouse/pycolmap-*.whl | head -n 1)

          if [ -z "$WHEEL" ]; then
            echo "ERROR: No wheel found in wheelhouse/"
            exit 1
          fi

          echo "Testing wheel: $WHEEL"

          # Install the wheel
          pip install "$WHEEL" --force-reinstall

          # Test import and version
          echo "Testing pycolmap import..."
          python -c "import pycolmap; print(f'pycolmap version: {pycolmap.__version__}')"

          if [ $? -ne 0 ]; then
            echo "ERROR: pycolmap import failed"
            exit 1
          fi
          echo "pycolmap smoke test passed"

      # ==================== Artifacts ====================
      - name: Rename wheels with variant suffix
        shell: bash
        working-directory: third_party/colmap-for-pycolmap
        run: |
          # Determine variant suffix for wheel filename
          if [ "${{ matrix.cudss }}" = "true" ]; then
            VARIANT="+cuda.cudss"
          elif [ "${{ matrix.cuda }}" = "true" ]; then
            VARIANT="+cuda"
          else
            VARIANT="+cpu"
          fi

          echo "Renaming wheels with variant: $VARIANT"

          # Rename each wheel to include variant in version
          # e.g., pycolmap-3.14.0.dev0-cp310-cp310-win_amd64.whl
          #    -> pycolmap-3.14.0.dev0+cuda-cp310-cp310-win_amd64.whl
          for wheel in wheelhouse/*.whl; do
            if [ -f "$wheel" ]; then
              filename=$(basename "$wheel")
              # Extract parts: name-version-pytag-abitag-platform.whl
              # Insert variant after version (before first -cp)
              newname=$(echo "$filename" | sed "s/\(pycolmap-[0-9.]*\.dev[0-9]*\)\(-cp\)/\1${VARIANT}\2/")
              if [ "$filename" != "$newname" ]; then
                echo "  $filename -> $newname"
                mv "$wheel" "wheelhouse/$newname"
              fi
            fi
          done

          echo "Renamed wheels:"
          ls -la wheelhouse/*.whl || echo "No wheels found"

      - name: Prepare artifact name
        id: artifact-name
        shell: bash
        run: |
          if [ "${{ matrix.cudss }}" = "true" ]; then
            CUDA_SUFFIX="CUDA-cuDSS"
          elif [ "${{ matrix.cuda }}" = "true" ]; then
            CUDA_SUFFIX="CUDA"
          else
            CUDA_SUFFIX="CPU"
          fi
          PYVER=$(echo "${{ matrix.python-version }}" | tr -d '.')
          echo "name=pycolmap-py${PYVER}-${{ matrix.os }}-${CUDA_SUFFIX}" >> $GITHUB_OUTPUT

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact-name.outputs.name }}
          path: third_party/colmap-for-pycolmap/wheelhouse/*.whl
          retention-days: 7
          if-no-files-found: error
