name: Release

on:
  push:
    tags:
      - 'v*'  # Auto-release on version tags
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string
      skip_build:
        description: 'Skip building and use existing artifacts'
        type: boolean
        default: false

permissions:
  contents: write
  packages: read

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ==================== Build Jobs ====================
  build-colmap:
    name: Build COLMAP
    if: ${{ !inputs.skip_build }}
    uses: ./.github/workflows/build-colmap.yml
    secrets: inherit

  build-glomap:
    name: Build GLOMAP
    if: ${{ !inputs.skip_build }}
    uses: ./.github/workflows/build-glomap.yml
    secrets: inherit

  build-pycolmap:
    name: Build pycolmap
    if: ${{ !inputs.skip_build }}
    uses: ./.github/workflows/build-pycolmap.yml
    secrets: inherit

  # ==================== Package and Release ====================
  create-release-packages:
    name: Create Release Packages
    needs: [build-colmap, build-glomap, build-pycolmap]
    if: |
      always() && (
        (needs.build-colmap.result == 'success' &&
         needs.build-glomap.result == 'success' &&
         needs.build-pycolmap.result == 'success') ||
        (inputs.skip_build &&
         needs.build-colmap.result == 'skipped' &&
         needs.build-glomap.result == 'skipped' &&
         needs.build-pycolmap.result == 'skipped')
      )
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts/ -type f -name "*.whl" -o -name "*.zip" -o -name "*.tar.gz" | head -100
          echo ""
          echo "Directory structure:"
          ls -la artifacts/

      # ==================== Package COLMAP ====================
      - name: Package COLMAP artifacts
        run: |
          mkdir -p packages

          for dir in artifacts/COLMAP-*; do
            if [ -d "$dir" ]; then
              name=$(basename "$dir")
              echo "Packaging $name..."
              cd "$dir"
              zip -r "../../packages/${name}.zip" .
              cd ../..
            fi
          done

          echo "COLMAP packages created:"
          ls -la packages/COLMAP-* || echo "No COLMAP packages"

      # ==================== Package GLOMAP ====================
      - name: Package GLOMAP artifacts
        run: |
          for dir in artifacts/GLOMAP-*; do
            if [ -d "$dir" ]; then
              name=$(basename "$dir")
              echo "Packaging $name..."
              cd "$dir"
              zip -r "../../packages/${name}.zip" .
              cd ../..
            fi
          done

          echo "GLOMAP packages created:"
          ls -la packages/GLOMAP-* || echo "No GLOMAP packages"

      # ==================== Collect pycolmap wheels ====================
      - name: Collect pycolmap wheels
        run: |
          mkdir -p packages/wheels

          # Find and copy all wheel files
          find artifacts/ -name "*.whl" -exec cp {} packages/wheels/ \;

          echo "pycolmap wheels:"
          ls -la packages/wheels/*.whl || echo "No wheels found"

      # ==================== Organize Wheels by Variant ====================
      - name: Organize wheels by variant
        run: |
          mkdir -p packages/wheels-cpu packages/wheels-cuda

          # CPU wheels (artifact name contains "-CPU")
          for dir in artifacts/pycolmap-*-CPU; do
            if [ -d "$dir" ]; then
              echo "Copying CPU wheels from $dir..."
              cp "$dir"/*.whl packages/wheels-cpu/ 2>/dev/null || true
            fi
          done

          # CUDA wheels (artifact name contains "-CUDA")
          for dir in artifacts/pycolmap-*-CUDA; do
            if [ -d "$dir" ]; then
              echo "Copying CUDA wheels from $dir..."
              cp "$dir"/*.whl packages/wheels-cuda/ 2>/dev/null || true
            fi
          done

          echo "CPU wheels:"
          ls -la packages/wheels-cpu/*.whl 2>/dev/null || echo "No CPU wheels"

          echo "CUDA wheels:"
          ls -la packages/wheels-cuda/*.whl 2>/dev/null || echo "No CUDA wheels"

      # ==================== Generate Checksums ====================
      - name: Generate SHA256 checksums
        run: |
          cd packages

          # Create checksums file
          echo "# SHA256 Checksums" > SHA256SUMS.txt
          echo "# Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> SHA256SUMS.txt
          echo "" >> SHA256SUMS.txt

          # COLMAP packages
          if ls COLMAP-*.zip 1>/dev/null 2>&1; then
            echo "## COLMAP" >> SHA256SUMS.txt
            sha256sum COLMAP-*.zip >> SHA256SUMS.txt
            echo "" >> SHA256SUMS.txt
          fi

          # GLOMAP packages
          if ls GLOMAP-*.zip 1>/dev/null 2>&1; then
            echo "## GLOMAP" >> SHA256SUMS.txt
            sha256sum GLOMAP-*.zip >> SHA256SUMS.txt
            echo "" >> SHA256SUMS.txt
          fi

          # CPU wheels
          if ls wheels-cpu/*.whl 1>/dev/null 2>&1; then
            echo "## pycolmap CPU wheels" >> SHA256SUMS.txt
            (cd wheels-cpu && sha256sum *.whl) >> SHA256SUMS.txt
            echo "" >> SHA256SUMS.txt
          fi

          # CUDA wheels
          if ls wheels-cuda/*.whl 1>/dev/null 2>&1; then
            echo "## pycolmap CUDA wheels" >> SHA256SUMS.txt
            (cd wheels-cuda && sha256sum *.whl) >> SHA256SUMS.txt
          fi

          echo "Generated checksums:"
          cat SHA256SUMS.txt

      # ==================== Upload Release Assets ====================
      - name: Get release tag
        id: release-tag
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "push" ]; then
            # Extract tag from ref (refs/tags/v1.0.0 -> v1.0.0)
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          fi

      # ==================== Generate release notes ====================
      - name: Generate release notes
        run: |
          cat > release_notes.md << 'RELEASE_EOF'
          Pre-built COLMAP, GLOMAP, and pycolmap binaries with CUDA support.

          ## Installation

          ### COLMAP

          **Windows:**
          ```powershell
          Expand-Archive COLMAP-windows-latest-CUDA.zip -DestinationPath C:\Tools\COLMAP
          C:\Tools\COLMAP\bin\colmap.exe gui
          ```

          **Linux:**
          ```bash
          unzip COLMAP-ubuntu-22.04-CUDA.zip -d ~/tools/colmap
          ~/tools/colmap/bin/colmap gui
          ```

          ### GLOMAP

          **Windows:**
          ```powershell
          Expand-Archive GLOMAP-windows-latest-CUDA12.8.1.zip -DestinationPath C:\Tools\GLOMAP
          C:\Tools\GLOMAP\bin\glomap.exe mapper --database_path db.db --image_path images --output_path sparse
          ```

          **Linux:**
          ```bash
          unzip GLOMAP-ubuntu-22.04-CUDA12.8.1.zip -d ~/tools/glomap
          ~/tools/glomap/bin/glomap mapper --database_path db.db --image_path images --output_path sparse
          ```

          ### pycolmap (pip install)

          **GPU/CUDA version (recommended):**
          ```bash
          pip install pycolmap --extra-index-url https://${{ github.repository_owner }}.github.io/build_gpu_colmap/
          ```

          **CPU version (from PyPI):**
          ```bash
          pip install pycolmap
          ```

          **Verify installation:**
          ```bash
          python -c "import pycolmap; print(pycolmap.__version__)"
          ```

          ## Package Variants

          | Variant | Description |
          |---------|-------------|
          | `CPU` | CPU-only (no NVIDIA GPU required) |
          | `CUDA` | GPU-accelerated (Windows: self-contained, Linux: requires CUDA Toolkit) |
          | `CUDA-cuDSS` | CUDA + cuDSS sparse solver (2-5x faster) |

          ## Why are Linux packages smaller?

          - **Windows (~1 GB):** Bundles all CUDA runtime DLLs for self-contained operation
          - **Linux (~25-45 MB):** Dynamically links to system CUDA libraries

          Linux CUDA builds require CUDA Toolkit installed: `sudo apt-get install nvidia-cuda-toolkit`

          ## System Requirements

          - **GPU:** NVIDIA RTX 20 series or newer (Compute Capability 7.5+)
          - **Driver:** 520+ (Windows), 525+ (Linux)
          - **Python:** 3.10, 3.11, 3.12, or 3.13 (for pycolmap)
          RELEASE_EOF

      - name: Upload assets and update release notes
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          append_body: true
          files: |
            packages/COLMAP-*.zip
            packages/GLOMAP-*.zip
            packages/wheels/*.whl
            packages/wheels-cpu/*.whl
            packages/wheels-cuda/*.whl
            packages/SHA256SUMS.txt
          fail_on_unmatched_files: false

      # ==================== Tag push: create draft release ====================
      - name: Create draft release (tag push)
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release-tag.outputs.tag }}
          name: Release ${{ steps.release-tag.outputs.tag }}
          draft: true
          body_path: release_notes.md
          files: |
            packages/COLMAP-*.zip
            packages/GLOMAP-*.zip
            packages/wheels/*.whl
            packages/wheels-cpu/*.whl
            packages/wheels-cuda/*.whl
            packages/SHA256SUMS.txt
          fail_on_unmatched_files: false

      # ==================== Manual dispatch: create draft release ====================
      - name: Create draft release (manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release-tag.outputs.tag }}
          name: Release ${{ steps.release-tag.outputs.tag }}
          draft: true
          body_path: release_notes.md
          files: |
            packages/COLMAP-*.zip
            packages/GLOMAP-*.zip
            packages/wheels/*.whl
            packages/wheels-cpu/*.whl
            packages/wheels-cuda/*.whl
            packages/SHA256SUMS.txt
          fail_on_unmatched_files: false

      # ==================== Summary ====================
      - name: Generate release summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### COLMAP Packages" >> $GITHUB_STEP_SUMMARY
          for f in packages/COLMAP-*.zip; do
            if [ -f "$f" ]; then
              size=$(du -h "$f" | cut -f1)
              name=$(basename "$f")
              echo "- \`$name\` ($size)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### GLOMAP Packages" >> $GITHUB_STEP_SUMMARY
          for f in packages/GLOMAP-*.zip; do
            if [ -f "$f" ]; then
              size=$(du -h "$f" | cut -f1)
              name=$(basename "$f")
              echo "- \`$name\` ($size)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### pycolmap CPU Wheels" >> $GITHUB_STEP_SUMMARY
          for f in packages/wheels-cpu/*.whl; do
            if [ -f "$f" ]; then
              size=$(du -h "$f" | cut -f1)
              name=$(basename "$f")
              echo "- \`$name\` ($size)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### pycolmap CUDA Wheels" >> $GITHUB_STEP_SUMMARY
          for f in packages/wheels-cuda/*.whl; do
            if [ -f "$f" ]; then
              size=$(du -h "$f" | cut -f1)
              name=$(basename "$f")
              echo "- \`$name\` ($size)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Checksums" >> $GITHUB_STEP_SUMMARY
          echo "SHA256SUMS.txt included in release for verification" >> $GITHUB_STEP_SUMMARY

      - name: Upload all packages as artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-packages-${{ steps.release-tag.outputs.tag }}
          path: packages/
          retention-days: 30
