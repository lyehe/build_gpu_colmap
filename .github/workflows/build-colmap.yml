name: Build COLMAP

on:
  workflow_call:
  push:
    branches: [master, main]
    paths:
      - 'CMakeLists.txt'
      - 'vcpkg.json'
      - 'third_party/colmap/**'
      - 'third_party/ceres-solver/**'
      - 'scripts_windows/**'
      - 'scripts_linux/**'
      - '.github/workflows/build-colmap.yml'
  pull_request:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      cuda:
        description: 'Build with CUDA'
        type: boolean
        default: true
      cudss:
        description: 'Build with cuDSS'
        type: boolean
        default: false

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # CUDA 12.8.1 builds (no GUI - for pycolmap/automation)
          - os: windows-latest
            cuda: true
            cuda_version: '12.8.1'
            cudss: true
            gui: false
            name: "Windows CUDA12.8+cuDSS"
          - os: windows-latest
            cuda: true
            cuda_version: '12.8.1'
            cudss: false
            gui: false
            name: "Windows CUDA12.8"
          - os: ubuntu-22.04
            cuda: true
            cuda_version: '12.8.1'
            cudss: true
            gui: false
            name: "Linux CUDA12.8+cuDSS"
          - os: ubuntu-22.04
            cuda: true
            cuda_version: '12.8.1'
            cudss: false
            gui: false
            name: "Linux CUDA12.8"
          # CPU builds (no GUI)
          - os: windows-latest
            cuda: false
            cudss: false
            gui: false
            name: "Windows CPU"
          - os: ubuntu-22.04
            cuda: false
            cudss: false
            gui: false
            name: "Linux CPU"
          # GUI builds (Windows only - for interactive use)
          - os: windows-latest
            cuda: true
            cuda_version: '12.8.1'
            cudss: true
            gui: true
            name: "Windows CUDA12.8+cuDSS+GUI"
          - os: windows-latest
            cuda: true
            cuda_version: '12.8.1'
            cudss: false
            gui: true
            name: "Windows CUDA12.8+GUI"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Fetch vcpkg history for baseline
        run: git -C third_party/vcpkg fetch --unshallow || true
        shell: bash

      # ==================== Disk Space Cleanup ====================
      - name: Free disk space (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "Disk space before cleanup:"
          df -h
          # Remove unnecessary large packages
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/share/swift
          # Clean apt cache
          sudo apt-get clean
          echo "Disk space after cleanup:"
          df -h

      # ==================== CUDA Setup ====================
      - name: Install CUDA Toolkit (Windows)
        if: matrix.cuda && runner.os == 'Windows'
        uses: Jimver/cuda-toolkit@v0.2.30
        with:
          cuda: ${{ matrix.cuda_version }}
          method: 'network'
          sub-packages: '["nvcc", "nvtx", "cudart", "curand", "curand_dev", "nvrtc_dev", "cublas", "cublas_dev", "cusparse", "cusparse_dev", "cusolver", "cusolver_dev", "cufft", "cufft_dev"]'
          log-file-suffix: '-${{ matrix.name }}.log'

      - name: Install CUDA Toolkit (Linux)
        if: matrix.cuda && runner.os == 'Linux'
        uses: Jimver/cuda-toolkit@v0.2.30
        with:
          cuda: ${{ matrix.cuda_version }}
          method: 'network'
          linux-local-args: '["--toolkit"]'
          log-file-suffix: '-${{ matrix.name }}.log'

      # ==================== cuDSS Setup ====================
      - name: Install cuDSS (Windows)
        if: matrix.cuda && matrix.cudss && runner.os == 'Windows'
        shell: pwsh
        run: |
          # Determine CUDA major version for cuDSS URL
          $cudaVersion = "${{ matrix.cuda_version }}"
          $cudaMajor = $cudaVersion.Split('.')[0]

          Write-Host "Downloading cuDSS for CUDA $cudaMajor..."
          $cudssUrl = "https://developer.download.nvidia.com/compute/cudss/redist/libcudss/windows-x86_64/libcudss-windows-x86_64-0.7.1.4_cuda${cudaMajor}-archive.zip"

          try {
            Invoke-WebRequest -Uri $cudssUrl -OutFile cudss.zip -UseBasicParsing
          } catch {
            Write-Error "Failed to download cuDSS: $_"
            exit 1
          }

          Write-Host "Extracting cuDSS..."
          Expand-Archive cudss.zip -DestinationPath "C:/cudss"

          # Find the extracted directory
          $cudssPath = Get-ChildItem -Path "C:/cudss" -Directory | Select-Object -First 1

          # Validate extraction
          if (-not (Test-Path "$($cudssPath.FullName)/include/cudss.h")) {
            Write-Error "cuDSS extraction failed - cudss.h not found"
            exit 1
          }

          Write-Host "cuDSS installed at: $($cudssPath.FullName)"
          echo "CUDSS_ROOT=$($cudssPath.FullName)" >> $env:GITHUB_ENV

      - name: Install cuDSS (Linux)
        if: matrix.cuda && matrix.cudss && runner.os == 'Linux'
        run: |
          # Determine CUDA major version for cuDSS URL
          CUDA_VERSION="${{ matrix.cuda_version }}"
          CUDA_MAJOR="${CUDA_VERSION%%.*}"

          echo "Downloading cuDSS for CUDA $CUDA_MAJOR..."
          CUDSS_URL="https://developer.download.nvidia.com/compute/cudss/redist/libcudss/linux-x86_64/libcudss-linux-x86_64-0.7.1.4_cuda${CUDA_MAJOR}-archive.tar.xz"

          if ! wget -nv "$CUDSS_URL" -O cudss.tar.xz; then
            echo "ERROR: Failed to download cuDSS"
            exit 1
          fi

          echo "Extracting cuDSS..."
          sudo mkdir -p /opt/nvidia/cudss
          sudo tar -xf cudss.tar.xz -C /opt/nvidia/cudss --strip-components=1

          # Validate extraction
          if [ ! -f "/opt/nvidia/cudss/include/cudss.h" ]; then
            echo "ERROR: cuDSS extraction failed - cudss.h not found"
            exit 1
          fi

          echo "cuDSS installed at: /opt/nvidia/cudss"
          echo "CUDSS_ROOT=/opt/nvidia/cudss" >> $GITHUB_ENV

      # ==================== Build Tools ====================
      - name: Install Ninja (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install ninja -y

      # Setup MSVC environment so cl.exe is in PATH for CUDA/vcpkg builds
      - name: Setup MSVC Developer Command Prompt
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install build dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl zip unzip tar pkg-config \
            autoconf autoconf-archive automake libtool make \
            ninja-build ccache \
            libgl-dev libgl1-mesa-dev libglu1-mesa-dev libglew-dev \
            libxmu-dev libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev \
            libomp-dev

      # ==================== Compiler Caching ====================
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1
        with:
          key: ccache-${{ matrix.os }}-${{ matrix.cuda && 'cuda' || 'cpu' }}
          max-size: 2G

      - name: Configure ccache (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "/usr/lib/ccache" >> $GITHUB_PATH

      # ==================== vcpkg Setup ====================
      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: '${{ github.workspace }}/third_party/vcpkg'
          vcpkgJsonGlob: 'vcpkg.json'
        env:
          # vcpkg binary caching via GitHub Actions cache
          VCPKG_BINARY_SOURCES: 'clear;default,readwrite'

      # ==================== Build ====================
      - name: Build COLMAP (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Building COLMAP with CUDA=${{ matrix.cuda }} GUI=${{ matrix.gui }}"
          $params = @{
            Configuration = "Release"
          }
          if ("${{ matrix.cuda }}" -ne "true") {
            $params.NoCuda = $true
          }
          if ("${{ matrix.gui }}" -eq "true") {
            $params.Gui = $true
          }
          .\scripts_windows\build_colmap.ps1 @params

      - name: Build COLMAP (Linux)
        if: runner.os == 'Linux'
        run: |
          CUDA_FLAG=""
          if [ "${{ matrix.cuda }}" != "true" ]; then
            CUDA_FLAG="--no-cuda"
          fi

          echo "Building COLMAP with CUDA=${{ matrix.cuda }}"
          chmod +x ./scripts_linux/build_colmap.sh
          ./scripts_linux/build_colmap.sh Release $CUDA_FLAG

      # ==================== Bundle vcpkg Dependencies (Windows) ====================
      - name: Bundle vcpkg DLLs (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $installBin = "build/install/colmap/bin"

          # Ensure bin directory exists
          if (-not (Test-Path $installBin)) {
            Write-Host "ERROR: COLMAP bin directory not found at $installBin" -ForegroundColor Red
            exit 1
          }

          # Copy vcpkg dependencies
          $vcpkgBin = "build/vcpkg_installed/x64-windows/bin"
          if (Test-Path "$vcpkgBin/*.dll") {
            Write-Host "Copying vcpkg DLLs from: $vcpkgBin"
            Copy-Item "$vcpkgBin/*.dll" $installBin -Force
          }

          Write-Host "Bundled vcpkg DLLs:" -ForegroundColor Green
          Get-ChildItem "$installBin/*.dll" | Select-Object Name

      # ==================== Bundle CUDA Runtime (Windows) ====================
      - name: Bundle CUDA DLLs (Windows)
        if: matrix.cuda && runner.os == 'Windows'
        shell: pwsh
        run: |
          $installBin = "build/install/colmap/bin"
          $cudaBin = "$env:CUDA_PATH\bin"

          if (-not (Test-Path $cudaBin)) {
            Write-Host "ERROR: CUDA bin directory not found at $cudaBin" -ForegroundColor Red
            exit 1
          }

          Write-Host "Copying CUDA runtime DLLs from: $cudaBin"
          Write-Host "Available CUDA DLLs in toolkit:"
          Get-ChildItem -Path $cudaBin -Filter "*.dll" | Where-Object { $_.Name -match "^(cu|nv)" } | Select-Object Name | Format-Table -HideTableHeaders

          # Copy essential CUDA runtime DLLs using -Filter for proper wildcard handling
          $cudaPatterns = @(
            "cudart64_*",
            "cublas64_*",
            "cublasLt64_*",
            "cusparse64_*",
            "cusolver64_*",
            "curand64_*",
            "cufft64_*",
            "nvrtc64_*",
            "nvrtc-builtins64_*",
            "nvJitLink_*"
          )

          $copiedCount = 0
          foreach ($pattern in $cudaPatterns) {
            $dlls = Get-ChildItem -Path $cudaBin -Filter "$pattern.dll" -ErrorAction SilentlyContinue
            foreach ($dll in $dlls) {
              Write-Host "  Copying: $($dll.Name)"
              Copy-Item $dll.FullName $installBin -Force
              $copiedCount++
            }
          }

          Write-Host "Copied $copiedCount CUDA DLLs" -ForegroundColor Green
          Write-Host "CUDA/NV DLLs in install bin:" -ForegroundColor Green
          Get-ChildItem -Path $installBin -Filter "*.dll" | Where-Object { $_.Name -match "^(cu|nv)" } | Select-Object Name

      # ==================== Bundle cuDSS ====================
      - name: Bundle cuDSS DLLs (Windows)
        if: matrix.cuda && matrix.cudss && runner.os == 'Windows'
        shell: pwsh
        run: |
          $installBin = "build/install/colmap/bin"

          # Find cuDSS DLLs in CUDSS_ROOT
          $searchDirs = @(
            "$env:CUDSS_ROOT/bin/12",
            "$env:CUDSS_ROOT/bin/13",
            "$env:CUDSS_ROOT/bin"
          )

          foreach ($dir in $searchDirs) {
            if (Test-Path "$dir/cudss*.dll") {
              Write-Host "Copying cuDSS DLLs from: $dir"
              Copy-Item "$dir/*.dll" $installBin -Force
              Get-ChildItem "$installBin/cudss*.dll" | ForEach-Object { Write-Host "  - $($_.Name)" }
              break
            }
          }

      - name: Bundle cuDSS libs (Linux)
        if: matrix.cuda && matrix.cudss && runner.os == 'Linux'
        run: |
          INSTALL_LIB="build/install/colmap/lib"

          for dir in "$CUDSS_ROOT/lib/12" "$CUDSS_ROOT/lib64/12" "$CUDSS_ROOT/lib" "$CUDSS_ROOT/lib64"; do
            if ls "$dir"/libcudss*.so* 1>/dev/null 2>&1; then
              echo "Copying cuDSS libs from: $dir"
              cp -f "$dir"/libcudss*.so* "$INSTALL_LIB/"
              ls -la "$INSTALL_LIB"/libcudss*.so*
              break
            fi
          done

      # ==================== Verify Build ====================
      - name: Verify cuDSS DLLs bundled (Windows)
        if: matrix.cuda && matrix.cudss && runner.os == 'Windows'
        shell: pwsh
        run: |
          $cudssDlls = Get-ChildItem "build/install/colmap/bin/cudss*.dll" -ErrorAction SilentlyContinue
          if (-not $cudssDlls) {
            Write-Host "ERROR: cuDSS DLLs not found in build/install/colmap/bin/" -ForegroundColor Red
            Write-Host "Contents of bin directory:" -ForegroundColor Yellow
            Get-ChildItem "build/install/colmap/bin/*.dll" | Select-Object Name
            Write-Host ""
            Write-Host "CUDSS_ROOT was: $env:CUDSS_ROOT" -ForegroundColor Yellow
            if ($env:CUDSS_ROOT) {
              Write-Host "Contents of CUDSS_ROOT:" -ForegroundColor Yellow
              Get-ChildItem $env:CUDSS_ROOT -Recurse -Name | Select-Object -First 30
            }
            exit 1
          }
          Write-Host "cuDSS DLLs found:" -ForegroundColor Green
          $cudssDlls | ForEach-Object { Write-Host "  - $($_.Name)" }

      - name: Verify cuDSS libs bundled (Linux)
        if: matrix.cuda && matrix.cudss && runner.os == 'Linux'
        run: |
          if ! ls build/install/colmap/lib/libcudss*.so* 1>/dev/null 2>&1; then
            echo "ERROR: cuDSS libraries not found in build/install/colmap/lib/"
            echo "Contents of lib directory:"
            ls -la build/install/colmap/lib/ | head -30
            echo ""
            echo "CUDSS_ROOT was: $CUDSS_ROOT"
            if [ -n "$CUDSS_ROOT" ]; then
              echo "Contents of CUDSS_ROOT:"
              find "$CUDSS_ROOT" -type f | head -30
            fi
            exit 1
          fi
          echo "cuDSS libraries found:"
          ls -la build/install/colmap/lib/libcudss*.so*

      # ==================== Bundle Qt for GUI builds ====================
      - name: Bundle Qt dependencies (Windows GUI)
        if: matrix.gui && runner.os == 'Windows'
        shell: pwsh
        run: |
          $installBin = "build/install/colmap/bin"
          $colmapExe = "$installBin/colmap.exe"

          if (-not (Test-Path $colmapExe)) {
            Write-Host "ERROR: colmap.exe not found at $colmapExe" -ForegroundColor Red
            exit 1
          }

          # Find windeployqt from vcpkg Qt installation
          $vcpkgInstalled = "build/vcpkg_installed/x64-windows"
          $windeployqt = Get-ChildItem -Path $vcpkgInstalled -Recurse -Filter "windeployqt.exe" -ErrorAction SilentlyContinue | Select-Object -First 1

          if (-not $windeployqt) {
            Write-Host "ERROR: windeployqt.exe not found in vcpkg_installed" -ForegroundColor Red
            Write-Host "Searching for Qt tools..." -ForegroundColor Yellow
            Get-ChildItem -Path $vcpkgInstalled -Recurse -Filter "*.exe" | Where-Object { $_.Name -like "*qt*" -or $_.Name -like "*deploy*" } | Select-Object FullName
            exit 1
          }

          Write-Host "Found windeployqt: $($windeployqt.FullName)"
          Write-Host "Running windeployqt on colmap.exe..."

          # Run windeployqt to copy Qt DLLs and plugins
          & $windeployqt.FullName $colmapExe --no-translations --no-system-d3d-compiler --no-opengl-sw

          if ($LASTEXITCODE -ne 0) {
            Write-Host "WARNING: windeployqt returned non-zero exit code, but continuing..." -ForegroundColor Yellow
          }

          # Verify platforms plugin exists - FAIL if missing (critical for GUI)
          $platformsDir = "$installBin/platforms"
          if (Test-Path "$platformsDir/qwindows.dll") {
            Write-Host "Qt platforms plugin bundled successfully:" -ForegroundColor Green
            Get-ChildItem $platformsDir
          } else {
            Write-Host "ERROR: Qt platforms plugin not bundled!" -ForegroundColor Red
            Write-Host "platforms/qwindows.dll is required for GUI to work" -ForegroundColor Red
            Write-Host "Contents of bin directory:" -ForegroundColor Yellow
            Get-ChildItem $installBin -Recurse | Select-Object FullName
            exit 1
          }

      # ==================== Smoke Test ====================
      - name: Smoke test COLMAP binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $colmap = "build/install/colmap/bin/colmap.exe"
          $binDir = "build/install/colmap/bin"

          if (-not (Test-Path $colmap)) {
            Write-Host "ERROR: colmap.exe not found at $colmap" -ForegroundColor Red
            exit 1
          }

          # List all DLLs in bin directory for diagnostics
          Write-Host "DLLs in bin directory:" -ForegroundColor Cyan
          Get-ChildItem -Path $binDir -Filter "*.dll" | Select-Object Name | Format-Table -HideTableHeaders

          Write-Host "Testing COLMAP binary..."
          $output = & $colmap --help 2>&1

          # Check if we got meaningful output (not just an error)
          if ($output -match "COLMAP" -or $output -match "Usage" -or $output -match "commands") {
            $output | Select-Object -First 10
            Write-Host "COLMAP smoke test passed" -ForegroundColor Green
          } else {
            Write-Host "ERROR: COLMAP binary failed to run or produced no output" -ForegroundColor Red
            Write-Host "Output was: $output"
            Write-Host ""
            Write-Host "Checking for missing DLL dependencies..." -ForegroundColor Yellow
            # Try to get more info about the failure
            try {
              $proc = Start-Process -FilePath $colmap -ArgumentList "--help" -Wait -PassThru -NoNewWindow -RedirectStandardOutput "stdout.txt" -RedirectStandardError "stderr.txt"
              Write-Host "Exit code: $($proc.ExitCode)"
              if (Test-Path "stdout.txt") { Write-Host "stdout: $(Get-Content stdout.txt -Raw)" }
              if (Test-Path "stderr.txt") { Write-Host "stderr: $(Get-Content stderr.txt -Raw)" }
            } catch {
              Write-Host "Process start failed: $_"
            }
            exit 1
          }

      - name: Smoke test COLMAP binary (Linux)
        if: runner.os == 'Linux'
        run: |
          COLMAP="build/install/colmap/bin/colmap"

          if [ ! -f "$COLMAP" ]; then
            echo "ERROR: colmap binary not found at $COLMAP"
            exit 1
          fi

          echo "Testing COLMAP binary..."
          OUTPUT=$("$COLMAP" --help 2>&1 || true)

          # Check if we got meaningful output (not just an error)
          if echo "$OUTPUT" | grep -qiE "(colmap|usage|commands)"; then
            echo "$OUTPUT" | head -10
            echo "COLMAP smoke test passed"
          else
            echo "ERROR: COLMAP binary failed to run or produced no output"
            echo "Output was: $OUTPUT"
            exit 1
          fi

      # ==================== Artifacts ====================
      - name: Prepare artifact name
        id: artifact-name
        shell: bash
        run: |
          CUDA_SUFFIX="${{ matrix.cuda && 'CUDA' || 'CPU' }}"
          CUDSS_SUFFIX="${{ matrix.cudss && '-cuDSS' || '' }}"
          GUI_SUFFIX="${{ matrix.gui && '-GUI' || '' }}"
          echo "name=COLMAP-${{ matrix.os }}-${CUDA_SUFFIX}${CUDSS_SUFFIX}${GUI_SUFFIX}" >> $GITHUB_OUTPUT

      - name: Upload COLMAP artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact-name.outputs.name }}
          path: |
            build/install/colmap/
          retention-days: 7
          if-no-files-found: error
